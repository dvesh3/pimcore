<VirtualHost *:80>
    ServerName pimcore-test.dev

    RewriteEngine on
    RewriteRule "^/(.*)" "https://pimcore-test.dev/$1" [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName pimcore-test.dev

    # turn off mod_deflate for PHP requests, ... this is necessary because of a bug in mod_fastcgi
    SetEnvIfNoCase Request_URI "\.(php)$" no-gzip dont-vary

    DocumentRoot %GITHUB_WORKSPACE_DIR%/web

    AddHandler php7.1-fcgi .php
    Action php7.1-fcgi /php7.1-fcgi
    Alias /php7.1-fcgi /usr/lib/cgi-bin/php7.1-fcgi-PROJECT

    FastCgiExternalServer /usr/lib/cgi-bin/php7.1-fcgi-PROJECT -host 127.0.0.1:9001 -pass-header Authorization
    <Directory /usr/lib/cgi-bin>
            Options ExecCGI FollowSymLinks
            SetHandler fastcgi-script
            Require all granted
    </Directory>

    <Directory %GITHUB_WORKSPACE_DIR%/web>
            Options FollowSymLinks
            AllowOverride All
            Require all granted
    </Directory>

    RewriteEngine On

    # THE FOLLOWING NEEDS TO BE THE VERY LAST REWRITE RULE IN THIS VHOST
    # this is needed to pass the auth header correctly - fastcgi environment
    RewriteRule ".*" "-" [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]



      SetEnv PIMCORE_TEST 1
      SetEnv PIMCORE_ENVIRONMENT %PIMCORE_ENVIRONMENT%
      SetEnv PIMCORE_TEST_DB_DSN %PIMCORE_TEST_DB_DSN%
      SetEnv PIMCORE_TEST_CACHE_REDIS_DATABASE %PIMCORE_TEST_CACHE_REDIS_DATABASE%
</VirtualHost>